-module('concert_notifier_server').

%% this file was generated by grpc

-export([decoder/0,
         'TrackConcerts'/3]).

-type 'Genre'() ::
    'ALL' |
    'SYMPHONIC_METAL' |
    'MELODIC_DEATH_METAL' |
    'POWER_METAL' |
    'THRASH_METAL' |
    'ACAPELLA_METAL' |
    'PROG_METAL'.

-type 'SubscriptionRequest'() ::
    #{'City' => [string()],
      'Band' => [string()],
      'Genre' => ['Genre'() | integer()]}.

-type 'ConcertEvent'() ::
    #{'City' => string(),
      'Band' => string()}.

-spec decoder() -> module().
%% The module (generated by gpb) used to encode and decode protobuf
%% messages.
decoder() -> 'concert_notifier'.

%% RPCs for service 'ConcertNotifier'

-spec 'TrackConcerts'(Message::'SubscriptionRequest'(), Stream::grpc:stream(), State::any()) ->
    {['ConcertEvent'()], grpc:stream()} | grpc:error_response().
%% This is a server-to-client streaming RPC
'TrackConcerts'(_Message, Stream, _State) ->
    io:format("Concert stream requested~n", []),
%    Generator = setup_concert_generator(),
%    io:format("Using generator at ~p~n", [Generator]),
    EndStream = send_notifications(_Message, Stream),
    {[#{}], EndStream}.

setup_concert_generator() ->
    case whereis(generator) of
        undefined -> concert_generator_sup:start();
        Pid -> Pid ! {subscribe, self()}, Pid
    end.

send_notifications(#{'City' := Cities, 'Band' := Bands, 'Genre' := Genres} = Preferences, Stream) ->
    receive
        {{Band, Genre}, City} -> 
            io:format("Concert generated: {~s, ~s}~n", [Band, City]),
            case (lists:member(Band, Bands) or lists:member(Genre, Genres)) and lists:member(City, Cities) of
                true -> 
                    io:format("Sending concert ~p~n", [construct_event(Band, City)]),
                    StreamContinuation = grpc:send(Stream, construct_event(Band, City)),
                    send_notifications(Preferences, StreamContinuation);
                false -> send_notifications(Preferences, Stream)
            end
        after 1000 ->
            StreamContinuation = grpc:send(Stream, construct_event('Epica', 'KrakÃ³w')),
            send_notifications(Preferences, StreamContinuation)
    end.

construct_event(Band, City) ->
    #{'City' => City, 'Band' => Band}.